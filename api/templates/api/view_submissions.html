{% extends "api/base.html" %}
{% load custom_filters %}

{% block title %}View Submissions{% endblock %}

{% block extra_css %}
<style>
    .submission-card {
        transition: transform 0.2s;
    }
    .submission-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 0.5rem 1rem rgba(0,0,0,0.15) !important;
    }
    .data-preview {
        max-height: 100px;
        overflow-y: auto;
        font-size: 0.875rem;
        background-color: #f8f9fa;
        padding: 10px;
        border-radius: 4px;
    }
    .search-box {
        border-radius: 50px;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
function syncNow() {
    const btn = document.getElementById('syncBtn');
    const icon = document.getElementById('syncIcon');
    
    // Disable button and show loading state
    btn.disabled = true;
    icon.classList.add('spinner-border', 'spinner-border-sm');
    icon.classList.remove('bi-arrow-repeat');
    btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Syncing...';
    
    // Get current search parameter if exists
    const urlParams = new URLSearchParams(window.location.search);
    const searchParam = urlParams.get('search');
    
    // Build sync URL
    let syncUrl = '?sync=true';
    if (searchParam) {
        syncUrl += '&search=' + encodeURIComponent(searchParam);
    }
    
    // Redirect to trigger sync
    window.location.href = syncUrl;
}
</script>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <div class="card">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <h4 class="mb-0">
                    <i class="bi bi-list-ul"></i> Survey Submissions
                </h4>
                <span class="badge bg-light text-primary badge-custom">
                    {{ submissions|length }} Total
                </span>
            </div>
            <div class="card-body">
                {% if sync_message %}
                    <div class="alert alert-{{ sync_status|default:'info' }} alert-dismissible fade show">
                        {% if sync_status == 'success' %}
                            <i class="bi bi-check-circle"></i>
                        {% elif sync_status == 'error' %}
                            <i class="bi bi-exclamation-triangle"></i>
                        {% else %}
                            <i class="bi bi-info-circle"></i>
                        {% endif %}
                        {{ sync_message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                {% endif %}

                <div class="row mb-4">
                    <div class="col-md-8">
                        <form method="get" class="input-group">
                            <input type="text" name="search" class="form-control search-box" 
                                   placeholder="Search submissions..." 
                                   value="{{ search_query }}">
                            <button class="btn btn-primary" type="submit">
                                <i class="bi bi-search"></i> Search
                            </button>
                        </form>
                    </div>
                    <div class="col-md-4 text-end">
                        <button type="button" class="btn btn-outline-primary" id="syncBtn" onclick="syncNow()">
                            <i class="bi bi-arrow-repeat" id="syncIcon"></i> Sync Now
                        </button>
                    </div>
                </div>

                {% if submissions %}
                    <div class="row">
                        {% for submission in submissions %}
                            <div class="col-md-6 col-lg-4 mb-4">
                                <div class="card submission-card h-100">
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <h6 class="text-muted mb-2">
                                                <i class="bi bi-calendar-check text-primary"></i> 
                                                {{ submission.date_submitted|date:"F d, Y" }}
                                            </h6>
                                            <small class="text-muted">
                                                <i class="bi bi-clock"></i> 
                                                {{ submission.date_submitted|time:"g:i A" }} BD Time
                                            </small>
                                        </div>

                                        <div class="data-preview">
                                            <small class="text-muted d-block mb-2"><strong>Quick Preview:</strong></small>
                                            {% for key, value in submission.data.items %}
                                                {% if not key|slice:":1" == "_" and key != "formhub" and key != "__version__" and key != "meta" and key|slice:":4" != "meta" and key|slice:":8" != "formhub/" and key != "start" and key != "end" and key != "Start" and key != "End" and forloop.counter <= 2 %}
                                                    <div class="mb-2">
                                                        <small class="text-primary fw-bold">{{ key|readable_field|truncatewords:3 }}</small><br>
                                                        <small class="text-dark">
                                                            {% if value|is_list %}
                                                                {{ value|join:", "|truncatewords:4 }}
                                                            {% else %}
                                                                {{ value|truncatewords:6 }}
                                                            {% endif %}
                                                        </small>
                                                    </div>
                                                {% endif %}
                                            {% endfor %}
                                        </div>

                                        <div class="mt-3">
                                            <a href="{% url 'submission-detail' submission.id %}" 
                                               class="btn btn-sm btn-primary w-100">
                                                <i class="bi bi-eye"></i> View Full Response
                                            </a>
                                        </div>
                                    </div>
                                    <div class="card-footer text-muted">
                                        <small>
                                            <i class="bi bi-download"></i> 
                                            Synced: {{ submission.date_synced|date:"M d, H:i" }}
                                        </small>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="text-center py-5">
                        <i class="bi bi-inbox" style="font-size: 4rem; color: #dee2e6;"></i>
                        <h5 class="mt-3 text-muted">No Submissions Yet</h5>
                        <p class="text-muted">
                            Submissions will appear here after you fill out the survey form.
                        </p>
                        <a href="{% url 'submit-survey' %}" class="btn btn-primary mt-3">
                            <i class="bi bi-pencil-square"></i> Submit Your First Survey
                        </a>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}
